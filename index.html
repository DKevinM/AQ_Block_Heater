<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AQHI Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .legend {
      background: white;
      padding: 10px;
      line-height: 1.5;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
    .logo-container {
      background: white;
      padding: 6px;
      border-radius: 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }
    .logo-container img {
      display: block;
      max-width: 100px;
      height: auto;
    }

    #calgary-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 8px 10px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.35);
      font-family: Arial;
      z-index: 1000;
    }
    
    #calgary-panel .title {
      font-weight: bold;
      margin-bottom: 6px;
    }
    
    #calgary-panel .row {
      display: flex;
      gap: 6px;
    }
    
    .aqhi-box {
      width: 42px;
      height: 42px;
      border-radius: 6px;
      color: #111;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }


    
  </style>
</head>
<body>
<div id="map"></div>
  
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="data.js"></script> 
<script src="js/calgary_aqhi.js"></script>
   
fetch("/CAN_AQHI/data/aqhi_observations.csv")

  
<script>
  const map = L.map('map').setView([51.045150, -114.045313], 11);
  let layerControl;

  // ---------------------------------------------
  // Base layers
  // ---------------------------------------------
  const baseLayers = {
    "Streets": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map),
    "Satellite": L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        maxZoom: 18,
        attribution: 'Tiles © Esri'
      }
    )
  };

  // Will hold label -> Leaflet layer
  const layerRegistry = {};

  // The *exact order* you want in the layer menu:
  const overlayOrder = [
    // point layers
    "Stations",
    "Sensors (PurpleAir)",
    // weather overlays (in desired order)
    "Radar",
    "Wind (U-component)",
    "Lightning",
    "Thunderstorm (3h)"
  ];

  const markerGroup = L.layerGroup();
  const paLayer     = L.layerGroup();

  layerRegistry["Stations"]          = markerGroup;
  layerRegistry["Sensors (PurpleAir)"] = paLayer;

  let overlayLayers = {};

  // ---------------------------------------------
  // AQHI colour function (for categories 1..10+)
  // ---------------------------------------------
  function getColor(aqhi) {
    const v = parseInt(aqhi);
    if (!isFinite(v) || v < 1) return "#D3D3D3";
    if (v >= 11) return "#640100";
  
    const lut = {
      1:"#01cbff",2:"#0099cb",3:"#016797",
      4:"#fffe03",5:"#ffcb00",6:"#ff9835",
      7:"#fd6866",8:"#fe0002",9:"#cc0001",10:"#9a0100"
    };
    return lut[v] || "#D3D3D3";
  }


  // ---------------------------------------------
  // Style function – uses confidence to vary opacity
  // ---------------------------------------------
  function style(feature) {
    const props = feature.properties || {};
    const v     = props.value;
    // keep this if you still want confidence in popups elsewhere:
    // const conf  = (props.confidence || "None").toLowerCase();
  
    return {
      fillColor: getColor(v),  // AQHI → color
      weight: 0.5,
      opacity: 0.6,
      color: 'white',
      fillOpacity: 0.7         // ← FIXED, no confidence
    };
  }


    // -----------------------------------------
    // Weather layers
    // -----------------------------------------
    const weatherLayers = {
      "Radar": L.tileLayer.wms("https://geo.weather.gc.ca/geomet/?lang=en", {
        layers: "RADAR_1KM_RRAI",
        format: "image/png",
        transparent: true,
        opacity: 0.85
      }),
      "Wind (U-component)": L.tileLayer.wms("https://geo.weather.gc.ca/geomet/?lang=en", {
        layers: "HRDPS.CONTINENTAL_UU",
        format: "image/png",
        transparent: true,
        opacity: 0.7
      }),
      "Lightning": L.tileLayer.wms("https://geo.weather.gc.ca/geomet", {
        layers: "Lightning_2.5km_Density",
        format: "image/png",
        transparent: true,
        opacity: 0.85
      }),
      "Thunderstorm (3h)": L.tileLayer.wms("https://geo.weather.gc.ca/geomet", {
        layers: "GDPS-WEonG_15km_Thunderstorm-Prob.3h",
        format: "image/png",
        transparent: true,
        opacity: 0.75
      })
    };

    // register weather layers in the same registry
    Object.entries(weatherLayers).forEach(([name, layer]) => {
      layerRegistry[name] = layer;
    });

    // Build overlayLayers strictly in overlayOrder
    overlayLayers = {};
    overlayOrder.forEach(name => {
      if (layerRegistry[name]) {
        overlayLayers[name] = layerRegistry[name];
      }
    });

    // Turn on stations and PurpleAir by default
    markerGroup.addTo(map);
    paLayer.addTo(map);

    layerControl = L.control.layers(baseLayers, overlayLayers, {
      collapsed: false
    }).addTo(map);



  // ---------------------------------------------
  // Legend (AQHI colours)
  // ---------------------------------------------
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = function () {
    const div = L.DomUtil.create('div', 'legend');
    const grades = ["1","2","3","4","5","6","7","8","9","10","10+"];
    grades.forEach(g => {
      div.innerHTML += `<i style="background:${getColor(g)}"></i> ${g}<br>`;
    });
    return div;
  };
  legend.addTo(map);

  // ---------------------------------------------
  // Logo
  // ---------------------------------------------
  const logo = L.control({ position: 'bottomright' });
  logo.onAdd = function () {
    const div = L.DomUtil.create('div', 'logo-container');
    div.innerHTML = `<img src="ACA_LOGO_CMYK.png" alt="Logo">`;
    return div;
  };
  logo.addTo(map);

  // ---------------------------------------------
  // Optional: auto-refresh every 60 minutes
  // ---------------------------------------------
  setInterval(() => location.reload(), 60 * 60 * 1000);
</script>


<script>
window.dataReady.then(() => {
  fetchAllStationData().then(allStations => {
    allStations.forEach(({ stationName, lat, lon, html, aqhi }) => {
      const fillColor = getColor(String(aqhi || "NA"));
      const marker = L.circleMarker([lat, lon], {
        radius: 7,
        fillColor,
        color: "#222",
        weight: 1,
        fillOpacity: 0.85
      }).bindPopup(html);
      marker.addTo(markerGroup);
    });
    markerGroup.addTo(map);
  });
});
</script>


<script>
  // PurpleAir eAQHI layer
  const PURPLE_URL = "https://raw.githubusercontent.com/DKevinM/AB_datapull/main/data/AB_PM25_map.json";

  // eAQHI = floor(pm_corr / 10) + 1, capped to 0–10
  function computeEAQHI(pm) {
    if (pm == null || isNaN(pm)) return null;
    let val = Math.floor(pm / 10) + 1;
    if (val < 0) val = 0;
    if (val > 10) val = 10;
    return val;
  }

  fetch(PURPLE_URL)
    .then(res => res.json())
    .then(data => {
      // handle either array or { data: [...] }
      const records = Array.isArray(data)
        ? data
        : (Array.isArray(data.data) ? data.data : []);

      records.forEach(rec => {
        const lat = parseFloat(rec.lat ?? rec.Latitude ?? rec.latitude);
        const lon = parseFloat(rec.lon ?? rec.Longitude ?? rec.longitude);
        const pm  = parseFloat(rec.pm_corr);

        if (!isFinite(lat) || !isFinite(lon) || !isFinite(pm)) return;

        const eAQHI = computeEAQHI(pm);
        if (eAQHI === null) return;

        // pull out sensor index (with a couple of fallbacks just in case)
        const sensorIndex = rec.sensor_index;
        
        const label = rec.name || (sensorIndex != null
          ? `Sensor ${sensorIndex}`
          : "Unnamed sensor");
        const color = getColor(String(eAQHI));

        const days = Number(new URLSearchParams(location.search).get("days")) || 7;
        
        const marker = L.circleMarker([lat, lon], {
          radius: 4,                 // ~50% smaller than stations (7)
          fillColor: color,
          color: "#222",
          weight: 0.5,
          fillOpacity: 0.85
        }).bindPopup(
          `<strong>PurpleAir</strong><br>` +
          `${label}<br>` +
           (sensorIndex != null ? `Sensor index: ${sensorIndex}<br>` : "") +
          `eAQHI: ${eAQHI}<br>` +
          `PM₂.₅ (corr): ${pm.toFixed(1)} µg/m³` +
          `<hr>` +
          `<a href="/AQHI.forecast/history/sensor_compare.html?sensor_index=${sensorIndex}"
             target="_blank">
             View historical PM2.5
          </a>`          
        );

        marker.addTo(paLayer);
      });

      // Turn on PurpleAir by default (optional)
      paLayer.addTo(map);
    })
    .catch(err => {
      console.error("Error loading PurpleAir data:", err);
    });

  loadCalgaryAQHI().then(drawCalgaryPanel);
  
</script>
  
  
</body>
</html>
